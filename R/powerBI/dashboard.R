
setwd("~/GitHub/InfluenceCampaigns/R/powerBI")
### get packages and functions
source("packages.R")  
source("functions.R")  

load_dot_env('Renviron.env')

detach("package:RMySQL", unload = TRUE)

## Dbase connection

library(DBI)

library(RMariaDB)
ssl = "~/GitHub/DigiCertGlobalRootCA.crt.pem"


con <- dbConnect(
        RMariaDB::MariaDB(),
        dbname = 'rmi_influence_campaign',
        username = Sys.getenv('DBASE_USER'),
        password = Sys.getenv("DBASE_PWD"),
        host = Sys.getenv('DBASE_IP'),
        port = '3306',
        ssl.ca = normalizePath("~/GitHub/DigiCertGlobalRootCA.crt.pem")
      )



# a <- dbListTables(con)
# 
# b <- as.character("allTraffic" , "campaignNewsletters" ,"campaignPosts"  ,  "contentSummary" ,   "donations", 
#           "geographyTraffic"  ,  "mediaReferrals"  ,    "SFcampaigns"   ,      "socialTraffic"    ,   "targetCampaign")
# 
# 
# readxl::excel_sheets('OCI+ Dashboard Dataset.xlsx')
# 
# for(i in readxl::excel_sheets('OCI+ Dashboard Dataset.xlsx')){
#   df <- read.xlsx('OCI+ Dashboard Dataset.xlsx', sheet = i, detectDates = TRUE)
#   dbWriteTable(con, i, df, append = TRUE)
# 
# }


### SET CAMPAIGN

#' Monday.com Token
mondayToken <- Sys.getenv("Monday_Token")

#' Sprout Social Token
sproutToken <- Sys.getenv("SproutSocial_Token")
sproutHeader <- c("Authorization" = sproutToken, "Accept" = "application/json", "Content-Type" = "application/json")
currentDate <- paste(Sys.Date())
sixMonthsAgo <- ymd(currentDate) - months(6) # Updated to 6 months on 2/5/2024.

#' Pardot API Token & Request Headers
pardotTokenV4 <- Sys.getenv("Pardot_TokenV4")
pardotTokenV5 <- Sys.getenv("Pardot_TokenV5")
pardotBusinessID <- Sys.getenv("Pardot_Business_ID")
header4 <- c("Authorization" = pardotTokenV4, "Pardot-Business-Unit-Id" = pardotBusinessID)
header5 <- c("Authorization" = pardotTokenV5, "Pardot-Business-Unit-Id" = pardotBusinessID)


## GA Authentication
ga_auth(email = "elizabeth.duchan@rmi.org")

#' SF Authentication
sf_auth()


## set google sheet
ss <- 'COP28_testing Dashboard Dataset.xlsx'

### START OF NEW VERSION

#campaigns <- c('OCI', 'Coal v Gas', "COP28")
campaigns <- unique(campaign_urls$campaign_tag)

allCampaignPages <- data.frame()


#campaign <- campaigns[3]
#campaignID <- campaign

# Use this once ready to process for multiple campaigns
for (i in campaigns){
  campaignID <- i  
  print(paste("Processing campaign:", campaignID))
  #campaign <- i
  #print(campaign)
  
  campaignPages <- campaign_urls %>% 
    filter(campaign_tag == campaignID)
  
  if (nrow(campaignPages) > 0) {
    allCampaignPages <- rbind(allCampaignPages, campaignPages)
  }
}

print(allCampaignPages)

campaignPages <- allCampaignPages

#campaignPages <- campaign_urls %>% 
 # filter(campaign_tag == campaignID)


### READ CAMPAIGN KEY
#campaignKey <- read.xlsx('Campaign Key.xlsx', sheet = paste0('Campaign Key - ', campaign))
#instead, we'd want to make this "key" on the r interface

#campaignID <- as.character(campaignKey[1, c('campaignID')])

#campaignPages <- campaign_urls[, c('propertyID', 'pagePath')]
propertyIDs <- unique(campaignPages$propertyID)
propertyIDs <- propertyIDs[!is.na(propertyIDs)]


#if (campaignID == 'COP28') campaignReports <- campaignKey[campaignKey$type =='Report', 'type'] %>%
# as.data.frame() %>% rename('reportID'='.') else 

campaignReports <- campaignPages[!is.na(campaignPages$reportID), 'reportID'] %>%
  as.data.frame() %>%
  rename('reportID'='.')

#if (campaignID == 'COP28') campaignEvents <- campaignKey[campaignKey$type=='Event', 'type'] %>%
# as.data.frame() %>% rename('eventID'='.') else 

campaignEvents <- campaignPages[!is.na(campaignPages$eventID), 'eventID'] %>%
  as.data.frame() %>%
  rename('eventID'='.')

#if(length(campaignReports) == 0) hasReport <- FALSE else hasReport <- TRUE
#if(length(campaignEvents) == 0) hasEvent <- FALSE else hasEvent <- TRUE

hasReport <- length(campaignReports) != 0
hasEvent <- length(campaignEvents) != 0

#if(campaignID == 'COP28') socialTag <- 'COP28' else 
 # socialTag <- as.character(campaignKey[1, c('socialTag')])

socialTag <- unique(campaignPages$campaign_tag[!is.na(campaignPages$campaign_tag)])


#### GOOGLE ANALYTICS ####
message('GETTING GOOGLE ANALYTICS DATA')

#' SUMMARY
#' 
#' 1. Pulls list of pages from campaign key file
#' 2. Gets page title and metadata by webscraping provided URLs
#' 3. For all pages
#'      Get key metrics - page views, users, engagement duration
#'      Get acquisition data - sessions + conversions - broken down by channel
#'      Get social media acquisition data - sessions
#'      Get page views broken down by country and region
#'      Get page traffic - sessions - driven by referral sources that have been identified as “Media” 
#'        - These sources are defined in the referralSites file
#' 4. If a new property ID is provided in the campaign key, process is repeated for the new website
#'    and datasets are combined
#' 5. write dataset

#' set GA variables and property ID
rmiPropertyID <- 354053620 #no longer will need?
metadataGA4 <- ga_meta(version = "data", rmiPropertyID)
dateRangeGA <- c("2023-01-01", paste(currentDate))


### get referral sites
referralSites <- read.xlsx('Referral Site Categories.xlsx', sheet = 'All Referral Sites')

###
campaignPages <- campaignPages %>% 
  mutate(site = ifelse(propertyID == rmiPropertyID, 'rmi.org', sub('/(.*)', '', sub('(.*)https://', '', pagePath)))) %>% 
  filter(!is.na(propertyID))

pageData <- data.frame(site = campaignPages$site, 
                       pageURL = campaignPages$pagePath, 
                       pageTitle = '', 
                       pageType = '', 
                       metadata = '',
                       program = '')

pageData <- getPageData(pageData)
# maybe need to check on hub once it's working

# Hard code section for pages without pageType in metadata
#pageData <- pageData %>% 
 # mutate(pageType = ifelse(pageTitle == 'RMI at COP - RMI', 'Hub', pageType),
  #       pageType = ifelse(pageTitle == 'RMI China Seminar at COP28', 'Event', pageType))

#' set page titles
rmiPages <- pageData %>% filter(site == 'rmi.org')
pages <- rmiPages[['pageTitle']]

#' get page metrics
pageMetrics <- getPageMetrics(rmiPropertyID, pages) 

#' get acquisition - CHECK.
acquisition <- getAcquisition(rmiPropertyID, pages) 

#' get social traffic
socialTraffic <- getTrafficSocial(rmiPropertyID, pages) 

#' get geographic segments
geographyTraffic <- getTrafficGeography(rmiPropertyID, pages) 

#' get referrals
mediaReferrals <- getReferrals(rmiPropertyID, pages)


#' get data for new website if a new GA property ID is provided
if(length(propertyIDs) > 1){
  
  #' set property ID for new website
  sitePropertyID <- propertyIDs[2]
  
  #' get pages
  newSitePages <- pageData %>% filter(site != 'rmi.org')
  pages <- unique(newSitePages[['pageTitle']])
  
  #' get website URL
  newSiteURL <- unique(newSitePages[['site']])
  
  ###
  
  #' get page metrics + acquisition
  pageMetricsNS <- getPageMetrics(sitePropertyID, pages) %>% 
    distinct()
  
  pageMetrics <- pageMetrics %>% rbind(pageMetricsNS)
  
  #' get acquisition
  acquisitionNS <- getAcquisition(sitePropertyID, pages, site = newSiteURL) 
  acquisition <- acquisition %>% rbind(acquisitionNS)
  
  #' bind page metrics and pivot table so that sessions/conversions are stored in one column
  #' this is to make a Power BI table column that changes based on an applied filter
  allTraffic <- pageData %>% 
    select(site, pageTitle) %>% 
    distinct() %>% 
    plyr::rbind.fill(acquisition) %>% 
    pivot_longer(cols = c(Sessions:DonationPageViews), names_to = "type", values_to = "count") %>% 
    mutate(count = round(count, 1)) %>% 
    left_join(select(pageMetrics, c(pageTitle, screenPageViews:avgEngagementDuration, pageType, icon)), by = 'pageTitle') %>% 
    mutate(count = as.numeric(ifelse(is.na(count), 0, count))) %>% 
    filter(defaultChannelGroup != 'Unassigned' & !is.na(defaultChannelGroup))
  
  numChannels <- allTraffic %>% group_by(pageTitle, type) %>% summarize(numChannels = n())
  
  allTraffic <- allTraffic %>% 
    left_join(numChannels) %>% 
    mutate('page_views' = round(screenPageViews/numChannels, 2)) %>% 
    select(-c(screenPageViews, numChannels))
  
  #' get social media acquisition and bind
  socialTrafficNS <- getTrafficSocial(sitePropertyID, pages, site = newSiteURL) 
  
  socialTraffic <- socialTraffic %>% 
    rbind(socialTrafficNS)
  
  #' get page traffic geography and bind
  geographyTrafficNS <- getTrafficGeography(sitePropertyID, pages, site = newSiteURL) 
  
  geographyTraffic <- geographyTraffic %>% 
    rbind(geographyTrafficNS) %>%
    rename(regionPageViews = 'Region Page Views')
  
  #' get media referrals and bind
  mediaReferralsNS <- getReferrals(sitePropertyID, pages, site = newSiteURL)
  
  mediaReferrals <- mediaReferrals %>% 
    rbind(mediaReferralsNS)
  
} else {
  #' bind page metrics and pivot table so that sessions/conversions are stored in one column
  #' this is to make a Power BI table column that changes based on an applied filter
  allTraffic <- pageData %>% 
    select(site, pageTitle) %>% 
    distinct() %>% 
    plyr::rbind.fill(acquisition) %>% 
    pivot_longer(cols = c(Sessions:DonationPageViews), names_to = "type", values_to = "count") %>% # Update to add additional GA4 goals in the select function
    mutate(count = round(count, 1)) %>% 
    left_join(select(pageMetrics, c(pageTitle, screenPageViews:avgEngagementDuration, pageType, program, icon)), by = 'pageTitle') %>% 
    mutate(count = as.numeric(ifelse(is.na(count), 0, count))) %>% 
    filter(defaultChannelGroup != 'Unassigned' & !is.na(defaultChannelGroup)) 
  
  numChannels <- allTraffic %>% group_by(pageTitle, type) %>% summarize(numChannels = n())
  
  allTraffic <- allTraffic %>% 
    left_join(numChannels) %>% 
    mutate('page_views' = round(screenPageViews/numChannels, 2)) %>% 
    select(-c(screenPageViews, numChannels))
  
}

allTraffic <- allTraffic %>%
  filter(!is.na(pageType))



### END OF NEW VERSION

# #### SET CAMPAIGN #### THIS IS THE OLD, UNTOUCHED VERSION
# 
# #would need to add new campaigns
# campaigns <- c('OCI', 'Coal v Gas', "COP28")
#' campaign <- campaigns[3]
#' campaignID <- campaign
#' 
#' # Use this once ready to process for multiple campaigns
#' for (i in campaigns){
#'   campaign <- i
#'   print(campaign)
#' }
#' 
#' ### READ CAMPAIGN KEY
#' campaignKey <- read.xlsx('Campaign Key.xlsx', sheet = paste0('Campaign Key - ', campaign))
#' #instead, we'd want to make this "key" on the r interface
#' 
#' #campaignID <- as.character(campaignKey[1, c('campaignID')])
#' campaignPages <- campaignKey[, c('propertyID', 'page')]
#' 
#' propertyIDs <- unique(campaignKey$propertyID)
#' propertyIDs <- propertyIDs[!is.na(propertyIDs)]
#' 
#' 
#' 
#' #if (campaignID == 'COP28') campaignReports <- campaignKey[campaignKey$type =='Report', 'type'] %>%
#'  # as.data.frame() %>% rename('reportID'='.') else 
#' 
#' campaignReports <- campaignKey[!is.na(campaignKey$reportID), 'reportID'] %>%
#'   as.data.frame() %>%
#'   rename('reportID'='.')
#' 
#' 
#' #if (campaignID == 'COP28') campaignEvents <- campaignKey[campaignKey$type=='Event', 'type'] %>%
#'  # as.data.frame() %>% rename('eventID'='.') else 
#'     
#' campaignEvents <- campaignKey[!is.na(campaignKey$eventID), 'eventID'] %>%
#'   as.data.frame() %>%
#'   rename('eventID'='.')
#' 
#' if(length(campaignReports) == 0) hasReport <- FALSE else hasReport <- TRUE
#' if(length(campaignEvents) == 0) hasEvent <- FALSE else hasEvent <- TRUE
#' 
#' if(campaignID == 'COP28') socialTag <- 'COP28' else 
#'   socialTag <- as.character(campaignKey[1, c('socialTag')])
#' 
#' 
#' #### GOOGLE ANALYTICS ####
#' message('GETTING GOOGLE ANALYTICS DATA')
#' 
#' #' SUMMARY
#' #' 
#' #' 1. Pulls list of pages from campaign key file
#' #' 2. Gets page title and metadata by webscraping provided URLs
#' #' 3. For all pages
#' #'      Get key metrics - page views, users, engagement duration
#' #'      Get acquisition data - sessions + conversions - broken down by channel
#' #'      Get social media acquisition data - sessions
#' #'      Get page views broken down by country and region
#' #'      Get page traffic - sessions - driven by referral sources that have been identified as “Media” 
#' #'        - These sources are defined in the referralSites file
#' #' 4. If a new property ID is provided in the campaign key, process is repeated for the new website
#' #'    and datasets are combined
#' #' 5. write dataset
#' 
#' #' set GA variables and property ID
#' rmiPropertyID <- 354053620 #no longer will need?
#' metadataGA4 <- ga_meta(version = "data", rmiPropertyID)
#' dateRangeGA <- c("2023-01-01", paste(currentDate))
#' 
#' 
#' ### get referral sites
#' referralSites <- read.xlsx('Referral Site Categories.xlsx', sheet = 'All Referral Sites')
#' 
#' ###
#' campaignPages <- campaignPages %>% 
#'   mutate(site = ifelse(propertyID == rmiPropertyID, 'rmi.org', sub('/(.*)', '', sub('(.*)https://', '', page)))) %>% 
#'   filter(!is.na(propertyID))
#' 
#' pageData <- data.frame(site = campaignPages$site, 
#'                        pageURL = campaignPages$page, 
#'                        pageTitle = '', 
#'                        pageType = '', 
#'                        metadata = '',
#'                        program = '')
#' 
#' pageData <- getPageData(pageData)
#' 
#' # Hard code section for pages without pageType in metadata
#' pageData <- pageData %>% 
#'   mutate(pageType = ifelse(pageTitle == 'RMI at COP - RMI', 'Hub', pageType),
#'          pageType = ifelse(pageTitle == 'RMI China Seminar at COP28', 'Event', pageType))
#' 
#' 
#' #' set page titles
#' rmiPages <- pageData %>% filter(site == 'rmi.org')
#' pages <- rmiPages[['pageTitle']]
#' 
#' #' get page metrics
#' pageMetrics <- getPageMetrics(rmiPropertyID, pages) 
#' 
#' #' get acquisition
#' acquisition <- getAcquisition(rmiPropertyID, pages) 
#' 
#' #' get social traffic
#' socialTraffic <- getTrafficSocial(rmiPropertyID, pages) 
#' 
#' #' get geographic segments
#' geographyTraffic <- getTrafficGeography(rmiPropertyID, pages) 
#' 
#' #' get referrals
#' mediaReferrals <- getReferrals(rmiPropertyID, pages)
#' 
#' 
#' 
#' #' get data for new website if a new GA property ID is provided
#' if(length(propertyIDs) > 1){
#'   
#'   #' set property ID for new website
#'   sitePropertyID <- propertyIDs[2]
#'   
#'   #' get pages
#'   newSitePages <- pageData %>% filter(site != 'rmi.org')
#'   pages <- unique(newSitePages[['pageTitle']])
#'   
#'   #' get website URL
#'   newSiteURL <- unique(newSitePages[['site']])
#'   
#'   ###
#'   
#'   #' get page metrics + acquisition
#'   pageMetricsNS <- getPageMetrics(sitePropertyID, pages) %>% 
#'     distinct()
#'   
#'   pageMetrics <- pageMetrics %>% rbind(pageMetricsNS)
#'   
#'   #' get acquisition
#'   acquisitionNS <- getAcquisition(sitePropertyID, pages, site = newSiteURL) 
#'   acquisition <- acquisition %>% rbind(acquisitionNS)
#'   
#'   #' bind page metrics and pivot table so that sessions/conversions are stored in one column
#'   #' this is to make a Power BI table column that changes based on an applied filter
#'   allTraffic <- pageData %>% 
#'     select(site, pageTitle) %>% 
#'     distinct() %>% 
#'     plyr::rbind.fill(acquisition) %>% 
#'     pivot_longer(cols = c(Sessions:DonationPageViews), names_to = "type", values_to = "count") %>% 
#'     mutate(count = round(count, 1)) %>% 
#'     left_join(select(pageMetrics, c(pageTitle, screenPageViews:avgEngagementDuration, pageType, icon)), by = 'pageTitle') %>% 
#'     mutate(count = as.numeric(ifelse(is.na(count), 0, count))) %>% 
#'     filter(defaultChannelGroup != 'Unassigned' & !is.na(defaultChannelGroup))
#'   
#'   numChannels <- allTraffic %>% group_by(pageTitle, type) %>% summarize(numChannels = n())
#'   
#'   allTraffic <- allTraffic %>% 
#'     left_join(numChannels) %>% 
#'     mutate('page_views' = round(screenPageViews/numChannels, 2)) %>% 
#'     select(-c(screenPageViews, numChannels))
#'   
#'   #' get social media acquisition and bind
#'   socialTrafficNS <- getTrafficSocial(sitePropertyID, pages, site = newSiteURL) 
#'   
#'   socialTraffic <- socialTraffic %>% 
#'     rbind(socialTrafficNS)
#'   
#'   #' get page traffic geography and bind
#'   geographyTrafficNS <- getTrafficGeography(sitePropertyID, pages, site = newSiteURL) 
#'   
#'   geographyTraffic <- geographyTraffic %>% 
#'     rbind(geographyTrafficNS) %>%
#'     rename(regionPageViews = 'Region Page Views')
#'   
#'   #' get media referrals and bind
#'   mediaReferralsNS <- getReferrals(sitePropertyID, pages, site = newSiteURL)
#'   
#'   mediaReferrals <- mediaReferrals %>% 
#'     rbind(mediaReferralsNS)
#'   
#' } else {
#'   #' bind page metrics and pivot table so that sessions/conversions are stored in one column
#'   #' this is to make a Power BI table column that changes based on an applied filter
#'   allTraffic <- pageData %>% 
#'     select(site, pageTitle) %>% 
#'     distinct() %>% 
#'     plyr::rbind.fill(acquisition) %>% 
#'     pivot_longer(cols = c(Sessions:DonationPageViews), names_to = "type", values_to = "count") %>% # Update to add additional GA4 goals in the select function
#'     mutate(count = round(count, 1)) %>% 
#'     left_join(select(pageMetrics, c(pageTitle, screenPageViews:avgEngagementDuration, pageType, program, icon)), by = 'pageTitle') %>% 
#'     mutate(count = as.numeric(ifelse(is.na(count), 0, count))) %>% 
#'     filter(defaultChannelGroup != 'Unassigned' & !is.na(defaultChannelGroup)) 
#'   
#'   numChannels <- allTraffic %>% group_by(pageTitle, type) %>% summarize(numChannels = n())
#'   
#'   allTraffic <- allTraffic %>% 
#'     left_join(numChannels) %>% 
#'     mutate('page_views' = round(screenPageViews/numChannels, 2)) %>% 
#'     select(-c(screenPageViews, numChannels))
#' 
#' }
#' 
#' allTraffic <- allTraffic %>%
#'   filter(!is.na(pageType))


### end of OLD, UNTOUCHED VERSION. ###

####'EMAIL NEWSLETTERS ####
message('GETTING NEWSLETTERS DATA')

#' SUMMARY
#' 
#' 1. Get all newsletters - Spark + Market Catalyst - from Newsletter Stats file
#' 2. Filter URLs to get newsletters that contain the page URLs in this campaign
#' 3. Write dataset

#' get all email stats 
#' 

if(!exists('allEmailStats')){
  allEmailStats <- getAllEmailStats()
}

#' get newsletter story URLs
pageURLs <- pageData$pageURL

#' get newsletter stories that match page URLS #SO CHECK WITH OCI ETC
campaignNewsletters <- getCampaignEmails(pageURLs) 

#' Set hasEmail to FALSE if no emails detected
if(nrow(campaignNewsletters) == 0) hasEmail <- FALSE else hasEmail <- TRUE

#if(hasEmail == TRUE){
  #' push data
 # message('PUSHING NEWSLETTER DATA')
  
 # ALL_NEWSLETTERS <- pushData(campaignNewsletters, 'Newsletters')
#}


#### SALESFORCE ####
message('GETTING SALESFORCE DATA')

#' SUMMARY
#' 
#' 1a Pull Salesforce campaign IDs for reports provided in campaign key
#'    Get affiliated campaign members and binds data from Salesforce Contacts/Leads/Accounts query
#' 1b Pull Salesforce campaign IDs for events provided in campaign key
#'    Get affiliated campaign members and binds data from Salesforce Contacts/Leads/Accounts query
#' 1c Pull Pardot list email IDs from the campaignNewsletters dataframe generated by the getCampaignNewsletters function
#'    Get all link clicks for newsletters from Pardot
#'    Get all prospects - contacts and leads with pardot activity - using getProspects function
#'    Joins dataframes using Pardot ID from the Pardot URL field to get contact/lead information
#' 2. Cleans data and joins account data for unknown contacts/leads using email domains 
#'    Categorizes audience groups using the govDomains file and audienceGroups file
#' 3. Bind all dataframes together
#' 4. Get donations - view process summary in Donations section
#' 5. Write dataset
#' 

if(hasReport == TRUE | hasEvent == TRUE | hasEmail == TRUE){
  
  #' create dataframe for campaigns
  df <- as.data.frame(matrix(0, ncol = 19, nrow = 0))
  names(df) <- c('CampaignName', 'EngagementType', 'Id', 'RecordType', 'Status', 'EngagementDate', 
                 'Name', 'Email', 'Domain', 'Account', 'AccountType', 'Industry', 'TotalGiving', 
                 'NumOpenOpps', 'Pardot_Score', 'Pardot_URL', 'Giving_Circle', 'Last_Gift', 'AccountId') 
  
  #' get list of campaigns
  campaignList <- getCampaignList()
  
  #' get all accounts
  if(!exists('all_accounts')){
    all_accounts <- getAllAccounts() 
  }
  
  #' remove accounts with duplicate names to avoid errors when joining by Account name
  accountsUnique <- all_accounts[!duplicated(all_accounts$Account) & !duplicated(all_accounts$Account, fromLast = TRUE),] %>% 
    filter(!grepl('unknown|not provided|contacts created by revenue grid', Account))
  
  ## get domain info for gov accounts
  govDomains <- read.xlsx('audiences/govDomains.xlsx') 
  
  ## get audience domains and accounts
  audienceGroups <- read.xlsx('audiences/audienceGroups.xlsx')
  audienceAccounts <- audienceGroups %>% select(Account, type) %>% filter(!is.na(Account)) %>% distinct(Account, .keep_all = TRUE)
  audienceDomains <- audienceGroups %>% select(Domain, type) %>% filter(!is.na(Domain)) %>% distinct(Domain, .keep_all = TRUE)

  #' get campaign member data for reports, events, and newsletter clicks
  if(hasReport == TRUE){
    campaignMembersReports <- getSalesforceReports()
    df <- df %>% rbind(campaignMembersReports)
  } 
  
  if(hasEvent == TRUE) {
    campaignMembersEvents <- getSalesforceEvents()
    df <- df %>% rbind(campaignMembersEvents)
  } 
  
  if(hasEmail == TRUE) {
    #' get all prospects
    if(!exists('prospects')){
      prospects <- getProspects() %>% 
        mutate(Domain = sub("(.*)\\@", "", Email))
    }
    
    campaignMembersNewsletters <- getCampaignNewsletters()
    df <- df %>% rbind(campaignMembersNewsletters)
  }
  
  #' remove duplicates
  SFcampaigns <- df %>% distinct(Id, CampaignName, .keep_all = TRUE)

  #' get donation revenue attributed to these campaign components
  donations <- getAttributedDonationValue(SFcampaigns)
  
  #' bind donations to SF campaign data
  donationsByCampaignMember <- donations %>% 
    group_by(Id, CampaignName) %>% 
    summarize(AttributtedDonationValue = sum(AttributtedValue))
  
  SFcampaigns <- SFcampaigns %>% 
    left_join(donationsByCampaignMember) %>% 
    select(CampaignName, EngagementType, Icon, Id, Status, EngagementDate, Domain, Email, 
           DonorType, AttributtedDonationValue, AccountId, Account, AccountType, Audience1, Audience2, Industry, 
           Pardot_URL, Pardot_ID, GivingCircleTF, SolutionsCouncilTF, InnovatorsCircleTF, OpenOppTF, DonorTF, 
           LapsedDonorsTF, DownloadTF, EventTF, EmailClickTF, Engagements) %>%
    mutate(CampaignName = case_when(EngagementType == 'Report Download' ~ 
                                      substring(CampaignName, 11),
                                    EngagementType == 'Event' ~ 
                                      substring(CampaignName, 11),
                                    TRUE ~ CampaignName),
           CampaignName = trimws(CampaignName))
}


#### SOCIAL MEDIA ####
message('GETTING SOCIAL MEDIA DATA')

#' SUMMARY
#' 
#' 1. Get all posts made after Jan 1, 2023 with tags from all social channels except for program LinkedIn accounts
#' 2. Request does not return the post account/profile ID so use post links - perma_link - to identify the account
#     NOTE: This works for all platforms except LinkedIn, which doesn't include account info in post URLs
#' 3. Get all posts for program Linkedin accounts, add account identifier, then bind all of these to posts retrieved in step 1
#' 4. Get averages for all get posts made over the last year, left join these values to all posts df
#' 6. Filter by campaign tag to get campaign posts
#' 7. Write dataset

#' get all sprout social tags
metadeta <- getMetadata(url = 'metadata/customer/tags')
tags <- metadeta[["data"]]

#' get post averages based on all posts made over the last year 
posts1YRaverages <- getPostAverages()

#' get all social media posts with tags except for posts made from program LinkedIn accounts
allPostsTags <- getAllSocialPosts()

#' get all posts from linkedIn program channels
linkedInTagged <- getLIProgramPosts('tagged')

#' clean and bind linkedin program posts to all posts
taggedPosts <- cleanPostDF(allPostsTags, 'tagged') %>% 
  rbind(linkedInTagged) %>% 
  left_join(posts1YRaverages, by = c('post_type', 'account')) %>% 
  #' calculate post performance compared to avgs.
  mutate(impressionsVmedian = round((impressions - impressionsMedian)/impressionsMedian, 3),
         engagementsVmedian = round((engagements - engagementsMedian)/engagementsMedian, 3),
         engrtVmedian = round((engagementRate - engrtMedian)/engrtMedian, 3),
         impressionsVmean = round((impressions - impressionsMean)/impressionsMean, 3),
         engagementsVmean = round((engagements - engagementsMean)/engagementsMean, 3),
         engrtVmean = round((engagementRate - engrtMean)/engrtMean, 3),
         brand = ifelse(grepl('RMI Brand', account), 1, 0),
         program = ifelse(brand == 1, 0, 1),
         accountType = ifelse(brand == 1, 'RMI Brand', 'RMI Program'),
         post = 'Post') %>% 
  select(created_time, account, post_type, icon, tag_id, tag_name, 
         impressions, impressionsVmedian, impressionsVmean, engagements, engagementsVmedian, engagementsVmean, 
         engagementRate, engrtVmedian, engrtVmean, postClicks, shares, 
         brand, program, accountType, post, perma_link, text)

#' find tagged posts for this campaign
if(campaign == 'oci+'){
  #' OCI posts were not tagged properly so get these by creating a custom filter
  campaignPosts <- taggedPosts %>% 
    filter(created_time >= '2023-04-05' & grepl('OCI\\+', text)) %>% 
    distinct(perma_link, .keep_all = TRUE) 
} else{
  campaignPosts <- taggedPosts %>% 
    filter(tag_name == socialTag) %>% 
    distinct(perma_link, .keep_all = TRUE)  #CHECK IF POPULATED W OCI
}



####' Monday.com ####
message('GETTING MONDAY.COM DATA')

#' SUMMARY
#' 
#' 1. Get all projects from Active Project Board
#' 2. Iterate through this board to find projects with "Metrics Dashboard" in the promotion tactics column
#' 3. Retrieve ID, audiences, and promotion tactics from these projects
#' 4. Filter for project that contains campaign ID
#' 5. Write data set
#' 


#' get Active Projects Board
#query <- "query { boards (ids: 2208962537) { items { id name column_values{ id value text } } } } "
##query <- "query { boards (ids: 2208962537) { items_page(limit: 500) { cursor items { id name column_values{ id value text } } } } } "

# completed board id: 4217437668


# Working to update API query to only get projects with "Metrics Dashboard" in the promotion tactics column direct from Monday
# query <- "query { items_page_by_column_values (limit: 500, board_id: 2208962537, columns: [{column_id: \"dropdown\", column_values: [\"Metrics Dashboard\"]}]) { cursor items { id  name  }  } } "
# activeProjectsID<- as.data.frame(res[["data"]][["items_page_by_column_values"]][["items"]][[1]])
# activeProjectsName <- as.data.frame(res[["data"]][["items_page_by_column_values"]][["items"]][[2]])
# projects <- cbind(activeProjectsID, activeProjectsName)
# names(projects) <- c('id', 'name')


##res <- getMondayCall(query)

##activeProjects <- as.data.frame(res[["data"]][["boards"]][["items_page"]][["items"]][[1]])



#' loop through Active Projects Board to find projects with "Metrics Dashboard" in the promotion tactics column
##projects <- data.frame(id = '', row = '', name = '')[0,]

##for(i in 1:nrow(activeProjects)){

  ##board <- activeProjects[[3]][[i]]
    ##if(grepl('Metrics Dashboard', paste(board[11, 'text']))){
    ##projects <- projects %>%
      ##rbind(c(paste(activeProjects[i, 'id']), i, c(paste(activeProjects[i, 'name']))))
     ##}
## }

##names(projects) <- c('id', 'row', 'name')


# Pulled this out from the loop, before it was included in the following loop and would be overwritten each time
##metricsDashboardCampaigns <- data.frame(CAMPAIGN_ID = '', name = '', ID = '', audiences = '',metrics = '', promotionTactics = '')[0,]

##row.names(campaignBoard) <- campaignBoard$id

##for(i in 1:nrow(projects)){
  

  #' get promotion tactics, audiences, and ID
 ## campaignRow <- as.numeric(projects[i, 'row']) # Changed this from 1 to i to get the correct row, before it was just looking at the first row
  ##campaignBoard <- activeProjects[[3]][[campaignRow]]
  ##campaignDF <- data.frame(CAMPAIGN_ID = campaignID,
           ##                name = projects[i, 'name'],
             ##              ID = campaignBoard[16, 'text'], 
                           # Assign value from text column to ID where id column equals text1
                         #  ID = campaignBoard['text1', 'text'],
                           
              ##             audiences = campaignBoard[15, 'text'], 
                          # audiences = campaignBoard['dropdown7', 'text'], 
                      
                  ##         metrics = campaignBoard[14, 'text'],
                          # metrics = campaignBoard['dropdown0', 'text'],
                      
                    ##       promotionTactics = campaignBoard[11, 'text']) 
  
##  metricsDashboardCampaigns <- metricsDashboardCampaigns %>% rbind(campaignDF)
  
##}

##metricsDashboardCampaigns <- metricsDashboardCampaigns %>% 
  ##mutate(promotionTactics = gsub(', Metrics Dashboard', '', promotionTactics))


##targetCampaign <- metricsDashboardCampaigns %>%
  ##filter(ID == campaignID)




### Looping testing!!!

#query1 <- "query { boards (ids: 2208962537) { items_page(limit: 500) { cursor items { id name column_values{ id value text } } } } }"
#query2 <- "query { boards (ids: 7114066583) { items_page(limit: 500) { cursor items { id name column_values{ id value text } } } } } "

#res1 <- getMondayCall(query1)
#res2 <- getMondayCall(query2)

#activeProjects <- as.data.frame(res1[["data"]][["boards"]][["items_page"]][["items"]][[1]])
#completedProjects <- as.data.frame(res2[["data"]][["boards"]][["items_page"]][["items"]][[1]])

# combining 
#allProjects <- rbind(activeProjects, completedProjects)

# print(str(allProjects))


# loop through Active Projects Board to find projects with "Metrics Dashboard" in the promotion tactics column
# projects had 0 observations?*!
#projects <- data.frame(id = '', row = '', name = '')[0,]

#for(i in 1:nrow(allProjects)){
 # board <- allProjects[[3]][[i]]
  #if(grepl('Metrics Dashboard', paste(board[11, 'text']))){
  #if(grepl('Article', paste(board[11, 'text']))){
   # projects <- projects %>%
    #  rbind(c(paste(allProjects[i, 'id']), i, c(paste(allProjects[i, 'name']))))
  #}
#}

#names(projects) <- c('id', 'row', 'name')

# Initialize the dataframe for metrics dashboard campaigns
#metricsDashboardCampaigns <- data.frame(CAMPAIGN_ID = '', name = '', ID = '', audiences = '', metrics = '', promotionTactics = '')[0,]

#row.names(campaignBoard) <- campaignBoard$id

#for(i in 1:nrow(projects)){
  
  #' get promotion tactics, audiences, and ID
 # campaignRow <- as.numeric(projects[i, 'row']) # Changed this from 1 to i to get the correct row, before it was just looking at the first row
  #campaignBoard <- allProjects[[3]][[campaignRow]]
  #campaignDF <- data.frame(CAMPAIGN_ID = campaignID,
   #                        name = projects[i, 'name'],
    #                       ID = campaignBoard[16, 'text'], 
                           # Assign value from text column to ID where id column equals text1
                           #  ID = campaignBoard['text1', 'text'],
                           
     #                      audiences = campaignBoard[15, 'text'], 
                           # audiences = campaignBoard['dropdown7', 'text'], 
                           
 #                          metrics = campaignBoard[14, 'text'],
                           # metrics = campaignBoard['dropdown0', 'text'],
                           
  #                         promotionTactics = campaignBoard[11, 'text']) 
  
#  metricsDashboardCampaigns <- metricsDashboardCampaigns %>% rbind(campaignDF)
  
#}


#metricsDashboardCampaigns <- metricsDashboardCampaigns %>% 
 # mutate(promotionTactics = gsub(', Metrics Dashboard', '', promotionTactics))


#targetCampaign <- metricsDashboardCampaigns %>%
#  filter(ID == campaignID)


### END

## looping with new consolidated Monday board!
# 7199415791

query <- "query { boards (ids: 7199415791) { items_page(limit: 500) { cursor items { id name column_values{ id value text } } } } } "

# completed board id: 4217437668


# Working to update API query to only get projects with "Metrics Dashboard" in the promotion tactics column direct from Monday
# query <- "query { items_page_by_column_values (limit: 500, board_id: 2208962537, columns: [{column_id: \"dropdown\", column_values: [\"Metrics Dashboard\"]}]) { cursor items { id  name  }  } } "
# activeProjectsID<- as.data.frame(res[["data"]][["items_page_by_column_values"]][["items"]][[1]])
# activeProjectsName <- as.data.frame(res[["data"]][["items_page_by_column_values"]][["items"]][[2]])
# projects <- cbind(activeProjectsID, activeProjectsName)
# names(projects) <- c('id', 'name')


res <- getMondayCall(query)

#maybe delete items page?  delete 
activeProjects <- as.data.frame(res[["data"]][["boards"]][["items_page"]][["items"]][[1]])


#' loop through Active Projects Board to find projects with "Metrics Dashboard" in the promotion tactics column
#projects <- data.frame(id = '', row = '', name = '')[0,]

# for(i in 1:nrow(activeProjects)){
  
 # board <- activeProjects[[3]][[i]]
#  if(grepl('Metrics Dashboard', paste(board[11, 'text']))){
   # projects <- projects %>%
  #    rbind(c(paste(activeProjects[i, 'id']), i, c(paste(activeProjects[i, 'name']))))
 # }
#}

#names(projects) <- c('id', 'row', 'name')

#removepromo tactics
# Pulled this out from the loop, before it was included in the following loop and would be overwritten each time
metricsDashboardCampaigns <- data.frame(campaignID = '', name = '', ID = '', audiences = '',metrics = '', promotionTactics = '')[0,]

#row.names(campaignBoard) <- campaignBoard$id

for(i in 1:nrow(activeProjects)){
  #' get promotion tactics, audiences, and ID
  #campaignRow <- as.numeric(activeProjects[i, 'row']) # Changed this from 1 to i to get the correct row, before it was just looking at the first row
  campaignBoard <- activeProjects[[3]][[i]]
  campaignDF <- data.frame(campaignID = campaignBoard[4,'text'],
                           name = activeProjects[i, 'name'],
                           ID = activeProjects[i, 'id'], 
                           # Assign value from text column to ID where id column equals text1
                           #  ID = campaignBoard['text1', 'text'],
                           audiences = campaignBoard[2, 'text'], 
                           # audiences = campaignBoard['dropdown7', 'text'], 
                           metrics = campaignBoard[3, 'text'])
  # metrics = campaignBoard['dropdown0', 'text'],
  #  promotionTactics = campaignBoard[11, 'text']) 
  metricsDashboardCampaigns <- metricsDashboardCampaigns %>% rbind(campaignDF)
}

#metricsDashboardCampaigns <- metricsDashboardCampaigns %>% 
 # mutate(promotionTactics = gsub(', Metrics Dashboard', '', promotionTactics))


targetCampaign <- metricsDashboardCampaigns %>%
  filter(campaignID == campaignID)



# end

#### CREATE CONTENT SUMMARY ####

#' SUMMARY
#' 
#' 1. Create content summary table for Campaign Summary tab on dashboard
#'    by getting instances of all social media posts, Salesforce campaigns - all reports, events, or newsletters - 
#'    and media referrals 
#' 2. Write dataset

socialContent <- campaignPosts %>% 
  mutate(type = 'Social Media Posts') %>% 
  select(type, name = post_type) 

salesforceContent <- SFcampaigns %>% 
  select(name = CampaignName, EngagementType) %>% 
  distinct() %>% 
  mutate(type = ifelse(EngagementType == 'Newsletter', 'Newsletters', 
                       ifelse(EngagementType == 'Report Download', 'Reports', 
                              ifelse(EngagementType == 'Event', 'Events', '')))) %>% 
  select(type, name)

mediaContent <- mediaReferrals %>% 
  mutate(type = 'Media Referrals') %>% 
  ungroup() %>% 
  select(type, name = mediaSubtype) 

contentSummary <- socialContent %>% 
  rbind(salesforceContent) %>% 
  rbind(mediaContent)


# Check to verify dataframes have more than 1 row, if not stop the script**

dfs <- list(allTraffic, socialTraffic, geographyTraffic, mediaReferrals,
            campaignNewsletters, SFcampaigns, donations, campaignPosts, targetCampaign,
            contentSummary)

dfs <- dfs %>% 
  set_names(c('allTraffic', 'socialTraffic', 'geographyTraffic', 'mediaReferrals', 
              'campaignNewsletters', 'SFcampaigns', 'donations', 'campaignPosts', 
              'targetCampaign', 'contentSummary'))


for (i in seq_along(dfs)) {
  if (nrow(dfs[[i]]) < 1) {
    # identify which data frame is empty by list item name
    stop('Empty dataframe: ', names(dfs)[i])
  }
}



# Delete all existing content for campaign from database
con <- dbConnect(
  RMariaDB::MariaDB(),
  dbname = 'rmi_influence_campaign',
  username = Sys.getenv('DBASE_USER'),
  password = Sys.getenv("DBASE_PWD"),
  host = Sys.getenv('DBASE_IP'),
  port = '3306',
  ssl.ca = normalizePath(ssl)
)

tables <- dbListTables(con)

dbDisconnect(con)

# compare audience values from targetcampaign in database and data frame
# drop records already in database
con <- dbConnect(
  RMariaDB::MariaDB(),
  dbname = 'rmi_influence_campaign',
  username = Sys.getenv('DBASE_USER'),
  password = Sys.getenv("DBASE_PWD"),
  host = Sys.getenv('DBASE_IP'),
  port = '3306',
  ssl.ca = normalizePath(ssl)
)

query <- paste0("SELECT audiences, metrics FROM targetcampaign where campaignID ='",campaignID, "'")
check_monday <- dbSendQuery(con, query) %>% dbFetch() %>% as.data.frame()

check_monday <- check_monday %>%
  mutate(check = paste(audiences, metrics))

targetCampaign <- targetCampaign %>% 
  mutate(check = paste(audiences, metrics)) %>%
  left_join(select(check_monday, check), by = 'check', keep = T) %>%
  filter(is.na(check.y)) %>%
  select(-c(check.x, check.y))


tables <- tables %>%
  str_replace("targetcampaign", "")

con <- dbConnect(
  RMariaDB::MariaDB(),
  dbname = 'rmi_influence_campaign',
  username = Sys.getenv('DBASE_USER'),
  password = Sys.getenv("DBASE_PWD"),
  host = Sys.getenv('DBASE_IP'),
  port = '3306',
  ssl.ca = normalizePath(ssl)
)

#for (i in tables){
 # query <- paste0("DELETE FROM ",i, " where campaignID ='",campaignID, "'")
  #dbExecute(con, query)
  #dbDisconnect(con)
#}

for (i in tables){
  tryCatch({
    query <- paste0("DELETE FROM ", i, " WHERE campaignID = '", campaignID, "'")
    dbSendQuery(con, query)
  }, error = function(e) {
    print(paste0("Error: ", e))
  })
  
}

#i="alltraffic"


#########################################################3

geographyTraffic <- geographyTraffic %>%
  rename(regionPageViews = c("Region Page Views"))



# Add campaignID to all dfs

allTraffic$campaignID = campaignID
socialTraffic$campaignID = campaignID
geographyTraffic$campaignID = campaignID
mediaReferrals$campaignID = campaignID
campaignNewsletters$campaignID = campaignID
SFcampaigns$campaignID = campaignID
donations$campaignID = campaignID
campaignPosts$campaignID = campaignID

if (nrow(targetCampaign) > 0){

  targetCampaign$campaignID = targetCampaign$campaignID
  targetCampaign <- select(targetCampaign, -c(campaignID, name))
  } else { }

contentSummary$campaignID = campaignID


# Write data to database

con <- dbConnect(
  RMariaDB::MariaDB(),
  dbname = 'rmi_influence_campaign',
  username = Sys.getenv('DBASE_USER'),
  password = Sys.getenv("DBASE_PWD"),
  host = Sys.getenv('DBASE_IP'),
  port = '3306',
  ssl.ca = normalizePath(ssl)
)

dfs <- list("allTraffic" = allTraffic, "socialTraffic" = socialTraffic, "geographyTraffic" = geographyTraffic, 
            "mediaReferrals" = mediaReferrals, "campaignNewsletters" =  campaignNewsletters, 
            "SFcampaigns"= SFcampaigns,"donations"= donations, "campaignPosts" = campaignPosts, 
            "targetCampaign"= targetCampaign, "contentSummary"= contentSummary)

if (nrow(targetCampaign) > 0){
  dbWriteTable(con, name = 'targetCampaign', value = targetCampaign, append = T)
  } else {print('No targetCampaign data to import')}

dbWriteTable(con, name = 'allTraffic', value = allTraffic, append = T)
#come back to, only oci?
dbWriteTable(con, name = 'socialTraffic', value = socialTraffic, append = T)
dbWriteTable(con, name = 'geographyTraffic', value = geographyTraffic, append = T)
dbWriteTable(con, name = 'mediaReferrals', value = mediaReferrals, append = T)
dbWriteTable(con, name = 'campaignNewsletters', value = campaignNewsletters, append = T)
dbWriteTable(con, name = 'campaignPosts', value = campaignPosts, append = T)
dbWriteTable(con, name = 'SFcampaigns', value = SFcampaigns, append = T)
dbWriteTable(con, name = 'contentSummary', value = contentSummary, append = T)
dbWriteTable(con, name = 'donations', value = donations, append = T)


# query <- paste0("DELETE FROM targetCampaign where campaignID ='",campaignID, "'")
# dbSendQuery(con, query)

dbDisconnect(con)



# for(i in dfs){
# 
#   dbWriteTable(con, i, i, append = T)
# }

write_xlsx(dfs, path = ss)


